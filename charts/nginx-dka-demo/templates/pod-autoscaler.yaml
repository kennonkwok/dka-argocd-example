{{- if .Values.autoscaler.enabled }}
---
# DatadogPodAutoscaler
# Manages scaling of the NGINX deployment based on Datadog metrics.
# This CRD is provided by the Datadog Operator.
apiVersion: datadoghq.com/v1alpha2
kind: DatadogPodAutoscaler
metadata:
  name: {{ .Release.Name }}-dpa
  namespace: {{ .Release.Namespace }}
  labels:
    app: {{ .Release.Name }}
    chart: {{ .Chart.Name }}-{{ .Chart.Version }}
    release: {{ .Release.Name }}
spec:
  # Target workload to scale
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: {{ .Release.Name }}

  # Owner designation - "Local" means Datadog cluster agent manages scaling
  # Alternative: "External" for managing from Datadog cloud
  owner: Local

  # Policy for applying scaling decisions
  applyPolicy:
    mode: Apply  # Actually apply scaling decisions (vs. Dryrun)

  # Scaling constraints
  constraints:
    minReplicas: {{ .Values.autoscaler.minReplicas }}
    maxReplicas: {{ .Values.autoscaler.maxReplicas }}

  objectives:
    - type: PodResource
      podResource:
        name: cpu
        value:
          type: Utilization
          utilization: 75
{{- end }}
