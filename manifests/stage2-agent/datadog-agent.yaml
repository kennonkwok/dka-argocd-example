---
# DatadogAgent Custom Resource
# Configures the Datadog Agent with workload autoscaling enabled.
# This CR is managed by the Datadog Operator deployed in Stage 1.
apiVersion: datadoghq.com/v2alpha1
kind: DatadogAgent
metadata:
  name: datadog
  namespace: datadog
spec:
  global:
    # Set your cluster name - this appears in Datadog UI
    clusterName: minikube-dka-demo

    # Datadog site (use datadoghq.eu for EU, etc.)
    site: datadoghq.com

    # Credentials reference - secret must exist before agent deployment
    credentials:
      apiSecret:
        secretName: datadog-secret
        keyName: api-key
      appSecret:
        secretName: datadog-secret
        keyName: app-key

    # Kubelet configuration for metrics collection
    kubelet:
      tlsVerify: false  # Set to true in production with proper certificates

  features:
    # Enable workload autoscaling (Datadog Kubernetes Autoscaling)
    workloadAutoscaling:
      enabled: true

    # Enable event collection with unbundled events
    eventCollection:
      collectKubernetesEvents: true
      unbundleEvents: true

  # Override specific components with environment variables
  override:
    clusterAgent:
      env:
        # Configure autoscaling failover behavior
        # When cluster agent is unavailable, HPA behavior is triggered
        - name: DD_AUTOSCALING_WORKLOAD_DISABLED_FALLBACK_TO_HPA
          value: "true"

        # Autoscaler update interval (how often to recalculate desired replicas)
        - name: DD_AUTOSCALING_WORKLOAD_AUTOSCALER_UPDATE_INTERVAL
          value: "30s"

        # Recommendation update interval (how often to send recommendations to Datadog)
        - name: DD_AUTOSCALING_WORKLOAD_RECOMMENDATION_UPDATE_INTERVAL
          value: "60s"
